{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/tobid/recipe-ui/app/api/generate/route.ts"],"sourcesContent":["export const runtime = \"nodejs\";\r\n\r\nexport async function POST(req: Request) {\r\n  // SIGNATURE (temp) — à supprimer après validation\r\n  if (req.headers.get(\"x-signature-check\") === \"1\") {\r\n    return Response.json({ ok: true, file: \"app/api/generate/route.ts\", mode: \"relative_urls_expected\" });\r\n  }\r\n\r\n  const n8n = process.env.N8N_BASE_URL;\r\n  if (!n8n) {\r\n    return Response.json(\r\n      { status: \"error\", error: { code: \"CONFIG\", message: \"N8N_BASE_URL missing\" } },\r\n      { status: 500 }\r\n    );\r\n  }\r\n\r\n  const payload = await req.json();\r\n\r\n  // FAST TEST: ne contacte pas n8n si x-dry-run=1\r\n  if (req.headers.get(\"x-dry-run\") === \"1\") {\r\n    return Response.json({\r\n      request_id: \"dry-run\",\r\n      status: \"done\",\r\n      echo: payload,\r\n      files: {\r\n        article: {\r\n          name: \"article_test.md\",\r\n          download_url: `/api/download/article?file_id=TEST&name=article_test.md`,\r\n        },\r\n        album_zip: {\r\n          name: \"album_test.zip\",\r\n          download_url: `/api/download/album?file_id=TEST&name=album_test.zip`,\r\n        },\r\n      },\r\n    });\r\n  }\r\n\r\n  const upstream = await fetch(`${n8n}/webhook/v1/generate`, {\r\n    method: \"POST\",\r\n    headers: { \"Content-Type\": \"application/json\" },\r\n    body: JSON.stringify(payload),\r\n  });\r\n\r\n  const data = await upstream.json();\r\n\r\n  // Réécriture RELATIVE (pas d'origin => OK local + prod + coolify)\r\n  if (data?.files?.article?.download_url) {\r\n    const u = new URL(data.files.article.download_url);\r\n    const file_id = u.searchParams.get(\"file_id\") || \"\";\r\n    const name = u.searchParams.get(\"name\") || \"article.md\";\r\n    data.files.article.download_url = `/api/download/article?file_id=${encodeURIComponent(file_id)}&name=${encodeURIComponent(name)}`;\r\n  }\r\n\r\n  if (data?.files?.album_zip?.download_url) {\r\n    const u = new URL(data.files.album_zip.download_url);\r\n    const file_id = u.searchParams.get(\"file_id\") || \"\";\r\n    const name = u.searchParams.get(\"name\") || \"album.zip\";\r\n    data.files.album_zip.download_url = `/api/download/album?file_id=${encodeURIComponent(file_id)}&name=${encodeURIComponent(name)}`;\r\n  }\r\n\r\n  return Response.json(data, { status: upstream.status });\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAO,MAAM,UAAU;AAEhB,eAAe,KAAK,GAAY;IACrC,kDAAkD;IAClD,IAAI,IAAI,OAAO,CAAC,GAAG,CAAC,yBAAyB,KAAK;QAChD,OAAO,SAAS,IAAI,CAAC;YAAE,IAAI;YAAM,MAAM;YAA6B,MAAM;QAAyB;IACrG;IAEA,MAAM,MAAM,QAAQ,GAAG,CAAC,YAAY;IACpC,IAAI,CAAC,KAAK;QACR,OAAO,SAAS,IAAI,CAClB;YAAE,QAAQ;YAAS,OAAO;gBAAE,MAAM;gBAAU,SAAS;YAAuB;QAAE,GAC9E;YAAE,QAAQ;QAAI;IAElB;IAEA,MAAM,UAAU,MAAM,IAAI,IAAI;IAE9B,gDAAgD;IAChD,IAAI,IAAI,OAAO,CAAC,GAAG,CAAC,iBAAiB,KAAK;QACxC,OAAO,SAAS,IAAI,CAAC;YACnB,YAAY;YACZ,QAAQ;YACR,MAAM;YACN,OAAO;gBACL,SAAS;oBACP,MAAM;oBACN,cAAc,CAAC,uDAAuD,CAAC;gBACzE;gBACA,WAAW;oBACT,MAAM;oBACN,cAAc,CAAC,oDAAoD,CAAC;gBACtE;YACF;QACF;IACF;IAEA,MAAM,WAAW,MAAM,MAAM,GAAG,IAAI,oBAAoB,CAAC,EAAE;QACzD,QAAQ;QACR,SAAS;YAAE,gBAAgB;QAAmB;QAC9C,MAAM,KAAK,SAAS,CAAC;IACvB;IAEA,MAAM,OAAO,MAAM,SAAS,IAAI;IAEhC,kEAAkE;IAClE,IAAI,MAAM,OAAO,SAAS,cAAc;QACtC,MAAM,IAAI,IAAI,IAAI,KAAK,KAAK,CAAC,OAAO,CAAC,YAAY;QACjD,MAAM,UAAU,EAAE,YAAY,CAAC,GAAG,CAAC,cAAc;QACjD,MAAM,OAAO,EAAE,YAAY,CAAC,GAAG,CAAC,WAAW;QAC3C,KAAK,KAAK,CAAC,OAAO,CAAC,YAAY,GAAG,CAAC,8BAA8B,EAAE,mBAAmB,SAAS,MAAM,EAAE,mBAAmB,OAAO;IACnI;IAEA,IAAI,MAAM,OAAO,WAAW,cAAc;QACxC,MAAM,IAAI,IAAI,IAAI,KAAK,KAAK,CAAC,SAAS,CAAC,YAAY;QACnD,MAAM,UAAU,EAAE,YAAY,CAAC,GAAG,CAAC,cAAc;QACjD,MAAM,OAAO,EAAE,YAAY,CAAC,GAAG,CAAC,WAAW;QAC3C,KAAK,KAAK,CAAC,SAAS,CAAC,YAAY,GAAG,CAAC,4BAA4B,EAAE,mBAAmB,SAAS,MAAM,EAAE,mBAAmB,OAAO;IACnI;IAEA,OAAO,SAAS,IAAI,CAAC,MAAM;QAAE,QAAQ,SAAS,MAAM;IAAC;AACvD"}}]
}