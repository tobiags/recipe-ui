{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/tobid/recipe-ui/app/api/download/%5Bkind%5D/route.ts"],"sourcesContent":["export const runtime = \"nodejs\";\r\n\r\nfunction contentDisposition(name: string) {\r\n  const safe = (name || \"file\").replace(/[\\r\\n\"]/g, \"\").trim();\r\n  return `attachment; filename=\"${safe}\"`;\r\n}\r\n\r\nexport async function GET(\r\n  req: Request,\r\n  { params }: { params: Promise<{ kind: string }> }\r\n) {\r\n  const n8n = process.env.N8N_BASE_URL;\r\n  if (!n8n) return new Response(\"N8N_BASE_URL missing\", { status: 500 });\r\n\r\n  const { kind: kindParam } = await params;\r\n\r\n  const rawKind = kindParam ?? \"\";\r\n  const kind = rawKind.toString().trim().toLowerCase().replace(/\\/+$/, \"\");\r\n\r\n\r\n\r\n  const url = new URL(req.url);\r\n  const file_id = url.searchParams.get(\"file_id\");\r\n  const name = url.searchParams.get(\"name\") || (kind === \"album\" ? \"album.zip\" : \"article.md\");\r\n\r\n  if (!file_id) return new Response(\"file_id required\", { status: 400 });\r\n\r\n  const upstreamPath =\r\n    kind === \"article\" ? \"article\" :\r\n    kind === \"album\" ? \"album\" :\r\n    null;\r\n\r\n  if (!upstreamPath) return new Response(\"unknown kind\", { status: 400 });\r\n\r\n  const upstream = await fetch(\r\n    `${n8n}/webhook/v1/download/${upstreamPath}?file_id=${encodeURIComponent(file_id)}&name=${encodeURIComponent(name)}`\r\n  );\r\n\r\n  if (!upstream.ok) {\r\n    const txt = await upstream.text().catch(() => \"\");\r\n    return new Response(txt || \"upstream error\", { status: upstream.status });\r\n  }\r\n\r\n   const headers = new Headers(upstream.headers);\r\n\r\n  // FIX: Ã©viter mismatch gzip/deflate entre upstream et Next/Node fetch\r\n  headers.delete(\"content-encoding\");\r\n  headers.delete(\"content-length\");\r\n\r\n  headers.set(\"Content-Disposition\", contentDisposition(name));\r\n\r\n  // (optionnel mais utile) content-type explicite\r\n  if (upstreamPath === \"album\") headers.set(\"Content-Type\", \"application/zip\");\r\n  if (upstreamPath === \"article\") headers.set(\"Content-Type\", \"text/markdown; charset=utf-8\");\r\n\r\n  return new Response(upstream.body, { status: 200, headers });\r\n\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAO,MAAM,UAAU;AAEvB,SAAS,mBAAmB,IAAY;IACtC,MAAM,OAAO,CAAC,QAAQ,MAAM,EAAE,OAAO,CAAC,YAAY,IAAI,IAAI;IAC1D,OAAO,CAAC,sBAAsB,EAAE,KAAK,CAAC,CAAC;AACzC;AAEO,eAAe,IACpB,GAAY,EACZ,EAAE,MAAM,EAAyC;IAEjD,MAAM,MAAM,QAAQ,GAAG,CAAC,YAAY;IACpC,IAAI,CAAC,KAAK,OAAO,IAAI,SAAS,wBAAwB;QAAE,QAAQ;IAAI;IAEpE,MAAM,EAAE,MAAM,SAAS,EAAE,GAAG,MAAM;IAElC,MAAM,UAAU,aAAa;IAC7B,MAAM,OAAO,QAAQ,QAAQ,GAAG,IAAI,GAAG,WAAW,GAAG,OAAO,CAAC,QAAQ;IAIrE,MAAM,MAAM,IAAI,IAAI,IAAI,GAAG;IAC3B,MAAM,UAAU,IAAI,YAAY,CAAC,GAAG,CAAC;IACrC,MAAM,OAAO,IAAI,YAAY,CAAC,GAAG,CAAC,WAAW,CAAC,SAAS,UAAU,cAAc,YAAY;IAE3F,IAAI,CAAC,SAAS,OAAO,IAAI,SAAS,oBAAoB;QAAE,QAAQ;IAAI;IAEpE,MAAM,eACJ,SAAS,YAAY,YACrB,SAAS,UAAU,UACnB;IAEF,IAAI,CAAC,cAAc,OAAO,IAAI,SAAS,gBAAgB;QAAE,QAAQ;IAAI;IAErE,MAAM,WAAW,MAAM,MACrB,GAAG,IAAI,qBAAqB,EAAE,aAAa,SAAS,EAAE,mBAAmB,SAAS,MAAM,EAAE,mBAAmB,OAAO;IAGtH,IAAI,CAAC,SAAS,EAAE,EAAE;QAChB,MAAM,MAAM,MAAM,SAAS,IAAI,GAAG,KAAK,CAAC,IAAM;QAC9C,OAAO,IAAI,SAAS,OAAO,kBAAkB;YAAE,QAAQ,SAAS,MAAM;QAAC;IACzE;IAEC,MAAM,UAAU,IAAI,QAAQ,SAAS,OAAO;IAE7C,sEAAsE;IACtE,QAAQ,MAAM,CAAC;IACf,QAAQ,MAAM,CAAC;IAEf,QAAQ,GAAG,CAAC,uBAAuB,mBAAmB;IAEtD,gDAAgD;IAChD,IAAI,iBAAiB,SAAS,QAAQ,GAAG,CAAC,gBAAgB;IAC1D,IAAI,iBAAiB,WAAW,QAAQ,GAAG,CAAC,gBAAgB;IAE5D,OAAO,IAAI,SAAS,SAAS,IAAI,EAAE;QAAE,QAAQ;QAAK;IAAQ;AAE5D"}}]
}